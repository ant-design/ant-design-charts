{"version":3,"file":"index.js","sources":["../src/HTMLRenderingPlugin.ts","../src/index.ts"],"sourcesContent":["import {\n  DisplayObject,\n  FederatedEvent,\n  GlobalRuntime,\n  HTML,\n  ICamera,\n  MutationEvent,\n  RenderingPlugin,\n  RenderingPluginContext,\n  CanvasEvent,\n  RenderReason,\n  isCSSRGB,\n  ElementEvent,\n  isPattern,\n  Shape,\n} from '@antv/g-lite';\nimport { isNil, isNumber, isString } from '@antv/util';\nimport type { mat4, vec3 } from 'gl-matrix';\n\nconst CANVAS_CAMERA_ID = 'g-canvas-camera';\n\nexport class HTMLRenderingPlugin implements RenderingPlugin {\n  static tag = 'HTMLRendering';\n\n  private context: RenderingPluginContext;\n\n  /**\n   * wrapper for camera\n   */\n  private $camera: HTMLDivElement;\n\n  private displayObjectHTMLElementMap = new WeakMap<\n    DisplayObject,\n    HTMLElement\n  >();\n\n  /**\n   * ! The reason for adding `offset` is that the `transform-origin` coordinate system of DOM is the local coordinate system of the element, while the `transform-origin` coordinate system of canvas drawing is the local coordinate system of the element's parent element. At the same time, the `transform` attribute value of the DOM element does not include `transform-origin`.\n   */\n  private joinTransformMatrix(matrix: mat4, offset: vec3 = [0, 0, 0]) {\n    return `matrix(${[\n      matrix[0],\n      matrix[1],\n      matrix[4],\n      matrix[5],\n      matrix[12] + offset[0],\n      matrix[13] + offset[1],\n    ].join(',')})`;\n  }\n\n  apply(context: RenderingPluginContext, runtime: GlobalRuntime) {\n    const { camera, renderingContext, renderingService } = context;\n    this.context = context;\n    const canvas = renderingContext.root.ownerDocument.defaultView;\n    const { nativeHTMLMap } = canvas.context.eventService;\n\n    const setTransform = (object: HTML, $el: HTMLElement) => {\n      $el.style.transform = this.joinTransformMatrix(\n        object.getWorldTransform(),\n        object.getOrigin(),\n      );\n    };\n\n    const handleMounted = (e: FederatedEvent) => {\n      const object = e.target as HTML;\n      if (object.nodeName === Shape.HTML) {\n        if (!this.$camera) {\n          this.$camera = this.createCamera(camera);\n        }\n\n        // create DOM element\n        const $el = this.getOrCreateEl(object);\n        this.$camera.appendChild($el);\n\n        Object.keys(object.attributes).forEach((name) => {\n          this.updateAttribute(name, object);\n        });\n\n        setTransform(object, $el);\n\n        nativeHTMLMap.set($el, object);\n      }\n    };\n\n    const handleUnmounted = (e: FederatedEvent) => {\n      const object = e.target as HTML;\n      if (object.nodeName === Shape.HTML && this.$camera) {\n        const $el = this.getOrCreateEl(object);\n        if ($el) {\n          $el.remove();\n          nativeHTMLMap.delete($el);\n        }\n      }\n    };\n\n    const handleAttributeChanged = (e: MutationEvent) => {\n      const object = e.target as HTML;\n      if (object.nodeName === Shape.HTML) {\n        const { attrName } = e;\n        this.updateAttribute(attrName, object);\n      }\n    };\n\n    const handleBoundsChanged = (e: MutationEvent) => {\n      const object = e.target as HTML;\n      const nodes =\n        object.nodeName === Shape.FRAGMENT ? object.childNodes : [object];\n\n      nodes.forEach((node: HTML) => {\n        if (node.nodeName === Shape.HTML) {\n          const $el = this.getOrCreateEl(node);\n          setTransform(node, $el);\n        }\n      });\n    };\n\n    const handleCanvasResize = () => {\n      if (this.$camera) {\n        const { width, height } = this.context.config;\n        this.$camera.parentElement.style.width = `${width || 0}px`;\n        this.$camera.parentElement.style.height = `${height || 0}px`;\n      }\n    };\n\n    renderingService.hooks.init.tap(HTMLRenderingPlugin.tag, () => {\n      canvas.addEventListener(CanvasEvent.RESIZE, handleCanvasResize);\n      canvas.addEventListener(ElementEvent.MOUNTED, handleMounted);\n      canvas.addEventListener(ElementEvent.UNMOUNTED, handleUnmounted);\n      canvas.addEventListener(\n        ElementEvent.ATTR_MODIFIED,\n        handleAttributeChanged,\n      );\n      canvas.addEventListener(ElementEvent.BOUNDS_CHANGED, handleBoundsChanged);\n    });\n\n    renderingService.hooks.endFrame.tap(HTMLRenderingPlugin.tag, () => {\n      if (\n        this.$camera &&\n        renderingContext.renderReasons.has(RenderReason.CAMERA_CHANGED)\n      ) {\n        this.$camera.style.transform = this.joinTransformMatrix(\n          camera.getOrthoMatrix(),\n        );\n      }\n    });\n\n    renderingService.hooks.destroy.tap(HTMLRenderingPlugin.tag, () => {\n      // remove camera\n      if (this.$camera) {\n        this.$camera.remove();\n      }\n\n      canvas.removeEventListener(CanvasEvent.RESIZE, handleCanvasResize);\n      canvas.removeEventListener(ElementEvent.MOUNTED, handleMounted);\n      canvas.removeEventListener(ElementEvent.UNMOUNTED, handleUnmounted);\n      canvas.removeEventListener(\n        ElementEvent.ATTR_MODIFIED,\n        handleAttributeChanged,\n      );\n      canvas.removeEventListener(\n        ElementEvent.BOUNDS_CHANGED,\n        handleBoundsChanged,\n      );\n    });\n  }\n\n  private createCamera(camera: ICamera) {\n    const { document: doc, width, height } = this.context.config;\n    const $canvas =\n      this.context.contextService.getDomElement() as unknown as HTMLElement;\n    const $container = $canvas.parentNode;\n    if ($container) {\n      const cameraId = CANVAS_CAMERA_ID;\n      let $existedCamera = $container.querySelector<HTMLDivElement>(\n        `#${cameraId}`,\n      );\n      if (!$existedCamera) {\n        // fix @see https://github.com/antvis/G/issues/1702\n        const $cameraContainer = (doc || document).createElement('div');\n        // HTML elements should not overflow with canvas @see https://github.com/antvis/G/issues/1163\n        $cameraContainer.style.overflow = 'hidden';\n        $cameraContainer.style.pointerEvents = 'none';\n        $cameraContainer.style.position = 'absolute';\n        $cameraContainer.style.left = `0px`;\n        $cameraContainer.style.top = `0px`;\n        $cameraContainer.style.width = `${width || 0}px`;\n        $cameraContainer.style.height = `${height || 0}px`;\n\n        const $camera = (doc || document).createElement('div');\n        $existedCamera = $camera;\n        $camera.id = cameraId;\n        // use absolute position\n        $camera.style.position = 'absolute';\n        // account for DOM element's offset @see https://github.com/antvis/G/issues/1150\n        $camera.style.left = `${$canvas.offsetLeft || 0}px`;\n        $camera.style.top = `${$canvas.offsetTop || 0}px`;\n        $camera.style.transformOrigin = 'left top';\n        $camera.style.transform = this.joinTransformMatrix(\n          camera.getOrthoMatrix(),\n        );\n        $camera.style.pointerEvents = 'none';\n        $camera.style.width = `100%`;\n        $camera.style.height = `100%`;\n\n        $cameraContainer.appendChild($camera);\n        $container.appendChild($cameraContainer);\n      }\n\n      return $existedCamera;\n    }\n    return null;\n  }\n\n  private getOrCreateEl(object: DisplayObject) {\n    const { document: doc } = this.context.config;\n    let $existedElement: HTMLElement | null =\n      this.displayObjectHTMLElementMap.get(object);\n\n    if (!$existedElement) {\n      $existedElement = (doc || document).createElement('div');\n      object.parsedStyle.$el = $existedElement;\n      this.displayObjectHTMLElementMap.set(object, $existedElement);\n      if (object.id) {\n        $existedElement.id = object.id;\n      }\n      if (object.name) {\n        $existedElement.setAttribute('name', object.name);\n      }\n      if (object.className) {\n        $existedElement.className = object.className;\n      }\n\n      // use absolute position\n      $existedElement.style.position = 'absolute';\n      // @see https://github.com/antvis/G/issues/1150\n      $existedElement.style['will-change'] = 'transform';\n      $existedElement.style.transform = this.joinTransformMatrix(\n        object.getWorldTransform(),\n        object.getOrigin(),\n      );\n    }\n\n    return $existedElement;\n  }\n\n  private updateAttribute(name: string, object: HTML) {\n    const $el = this.getOrCreateEl(object);\n    switch (name) {\n      case 'innerHTML':\n        const { innerHTML } = object.parsedStyle;\n        if (isString(innerHTML)) {\n          $el.innerHTML = innerHTML;\n        } else {\n          $el.innerHTML = '';\n          $el.appendChild(innerHTML);\n        }\n        break;\n      case 'x':\n        $el.style.left = `${object.parsedStyle.x}px`;\n        break;\n      case 'y':\n        $el.style.top = `${object.parsedStyle.y}px`;\n        break;\n      case 'transformOrigin':\n        const { transformOrigin } = object.parsedStyle;\n        $el.style['transform-origin'] = `${transformOrigin[0].buildCSSText(\n          null,\n          null,\n          '',\n        )} ${transformOrigin[1].buildCSSText(null, null, '')}`;\n        break;\n      case 'width':\n        const { width } = object.parsedStyle;\n        $el.style.width = isNumber(width)\n          ? `${width}px`\n          : (width as string).toString();\n        break;\n      case 'height':\n        const { height } = object.parsedStyle;\n        $el.style.height = isNumber(height)\n          ? `${height}px`\n          : (height as string).toString();\n        break;\n      case 'zIndex':\n        const { zIndex } = object.parsedStyle;\n        $el.style['z-index'] = `${zIndex}`;\n        break;\n      case 'visibility':\n        const { visibility } = object.parsedStyle;\n        $el.style.visibility = visibility;\n        break;\n      case 'pointerEvents':\n        const { pointerEvents = 'auto' } = object.parsedStyle;\n        $el.style.pointerEvents = pointerEvents;\n        break;\n      case 'opacity':\n        const { opacity } = object.parsedStyle;\n        $el.style.opacity = `${opacity}`;\n        break;\n      case 'fill':\n        const { fill } = object.parsedStyle;\n        let color = '';\n        if (isCSSRGB(fill)) {\n          if (fill.isNone) {\n            color = 'transparent';\n          } else {\n            color = object.getAttribute('fill') as string;\n          }\n        } else if (Array.isArray(fill)) {\n          color = object.getAttribute('fill') as string;\n        } else if (isPattern(fill)) {\n          // TODO: pattern, use background?\n        }\n        $el.style.background = color;\n        break;\n      case 'stroke':\n        const { stroke } = object.parsedStyle;\n        let borderColor = '';\n        if (isCSSRGB(stroke)) {\n          if (stroke.isNone) {\n            borderColor = 'transparent';\n          } else {\n            borderColor = object.getAttribute('stroke') as string;\n          }\n        } else if (Array.isArray(stroke)) {\n          borderColor = object.getAttribute('stroke') as string;\n        } else if (isPattern(stroke)) {\n          // TODO: pattern, use background?\n        }\n\n        $el.style['border-color'] = borderColor;\n        $el.style['border-style'] = 'solid';\n        break;\n      case 'lineWidth':\n        const { lineWidth } = object.parsedStyle;\n        $el.style['border-width'] = `${lineWidth || 0}px`;\n        break;\n      case 'lineDash':\n        $el.style['border-style'] = 'dashed';\n        break;\n      case 'filter':\n        const { filter } = object.style;\n        $el.style.filter = filter;\n        break;\n      default:\n        if (!isNil(object.style[name]) && object.style[name] !== '') {\n          $el.style[name] = object.style[name];\n        }\n    }\n  }\n}\n","import { AbstractRendererPlugin } from '@antv/g-lite';\nimport { HTMLRenderingPlugin } from './HTMLRenderingPlugin';\n\nexport class Plugin extends AbstractRendererPlugin {\n  name = 'html-renderer';\n  init(): void {\n    this.addRenderingPlugin(new HTMLRenderingPlugin());\n  }\n  destroy(): void {\n    this.removeAllRenderingPlugins();\n  }\n}\n"],"names":["CANVAS_CAMERA_ID","HTMLRenderingPlugin","_classCallCheck","displayObjectHTMLElementMap","WeakMap","_createClass","key","value","joinTransformMatrix","matrix","offset","arguments","length","undefined","concat","join","apply","context","runtime","_this","camera","renderingContext","renderingService","canvas","root","ownerDocument","defaultView","nativeHTMLMap","eventService","setTransform","object","$el","style","transform","getWorldTransform","getOrigin","handleMounted","e","target","nodeName","Shape","HTML","$camera","createCamera","getOrCreateEl","appendChild","Object","keys","attributes","forEach","name","updateAttribute","set","handleUnmounted","remove","handleAttributeChanged","attrName","handleBoundsChanged","nodes","FRAGMENT","childNodes","node","handleCanvasResize","_this$context$config","config","width","height","parentElement","hooks","init","tap","tag","addEventListener","CanvasEvent","RESIZE","ElementEvent","MOUNTED","UNMOUNTED","ATTR_MODIFIED","BOUNDS_CHANGED","endFrame","renderReasons","has","RenderReason","CAMERA_CHANGED","getOrthoMatrix","destroy","removeEventListener","_this$context$config2","doc","document","$canvas","contextService","getDomElement","$container","parentNode","cameraId","$existedCamera","querySelector","$cameraContainer","createElement","overflow","pointerEvents","position","left","top","id","offsetLeft","offsetTop","transformOrigin","$existedElement","get","parsedStyle","setAttribute","className","innerHTML","isString","x","y","buildCSSText","isNumber","toString","zIndex","visibility","_object$parsedStyle$p","opacity","fill","color","isCSSRGB","isNone","getAttribute","Array","isArray","isPattern","background","stroke","borderColor","lineWidth","filter","isNil","Plugin","_AbstractRendererPlug","_len","args","_key","_callSuper","_inherits","addRenderingPlugin","removeAllRenderingPlugins","AbstractRendererPlugin"],"mappings":"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"}