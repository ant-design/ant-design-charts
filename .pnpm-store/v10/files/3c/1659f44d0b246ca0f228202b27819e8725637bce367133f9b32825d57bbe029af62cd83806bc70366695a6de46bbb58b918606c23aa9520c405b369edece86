"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.build = build;
const child_process_1 = require("child_process");
const fs_1 = require("fs");
const nanoid_1 = require("nanoid");
const path_1 = require("path");
const find_root_1 = require("./find-root");
const project_1 = require("./project");
const util_1 = require("./util");
const webpackCompat_1 = require("./webpackCompat");
const xcodeProfile_1 = require("./xcodeProfile");
function build(options, projectPath, rootPath) {
    const bundleOptions = options.compatMode
        ? (0, webpackCompat_1.compatOptionsFromWebpack)(options)
        : options;
    if (!rootPath) {
        // help user to find the rootDir automatically.
        rootPath = (0, find_root_1.findRootDir)(projectPath || process.cwd());
    }
    return buildInternal(bundleOptions, projectPath, rootPath);
}
async function buildInternal(bundleOptions, projectPath, rootPath) {
    var _a, _b, _c, _d;
    (0, util_1.blockStdout)();
    if (process.env.XCODE_PROFILE) {
        await (0, xcodeProfile_1.xcodeProfilingReady)();
    }
    const createProject = (0, project_1.projectFactory)();
    const project = await createProject({
        processEnv: (_a = bundleOptions.processEnv) !== null && _a !== void 0 ? _a : {},
        defineEnv: (0, util_1.createDefineEnv)({
            config: bundleOptions.config,
            dev: (_b = bundleOptions.dev) !== null && _b !== void 0 ? _b : false,
            optionDefineEnv: bundleOptions.defineEnv,
        }),
        watch: {
            enable: false,
        },
        dev: (_c = bundleOptions.dev) !== null && _c !== void 0 ? _c : false,
        buildId: bundleOptions.buildId || (0, nanoid_1.nanoid)(),
        config: {
            ...bundleOptions.config,
            stats: Boolean(process.env.ANALYZE) || bundleOptions.config.stats,
        },
        projectPath: projectPath || process.cwd(),
        rootPath: rootPath || projectPath || process.cwd(),
        packPath: (0, util_1.getPackPath)(),
    }, {
        persistentCaching: false,
    });
    const entrypoints = await project.writeAllEntrypointsToDisk();
    const topLevelErrors = [];
    const topLevelWarnings = [];
    for (const issue of entrypoints.issues) {
        if (issue.severity === "error" || issue.severity === "fatal") {
            topLevelErrors.push((0, util_1.formatIssue)(issue));
        }
        else if ((0, util_1.isRelevantWarning)(issue)) {
            topLevelWarnings.push((0, util_1.formatIssue)(issue));
        }
    }
    if (topLevelWarnings.length > 0) {
        console.warn(`Utoopack build encountered ${topLevelWarnings.length} warnings:\n${topLevelWarnings.join("\n")}`);
    }
    if (topLevelErrors.length > 0) {
        throw new Error(`Utoopack build failed with ${topLevelErrors.length} errors:\n${topLevelErrors.join("\n")}`);
    }
    await project.shutdown();
    if (process.env.ANALYZE) {
        await analyzeBundle(projectPath || process.cwd(), ((_d = bundleOptions.config.output) === null || _d === void 0 ? void 0 : _d.path) || "dist");
    }
    // TODO: Maybe run tasks in worker is a better way, see
    // https://github.com/vercel/next.js/blob/512d8283054407ab92b2583ecce3b253c3be7b85/packages/next/src/lib/worker.ts
}
async function analyzeBundle(projectPath, outputPath) {
    const statsPath = (0, path_1.join)(projectPath, outputPath, "stats.json");
    if (!(0, fs_1.existsSync)(statsPath)) {
        console.warn(`Stats file not found at ${statsPath}. Make sure to enable stats in your configuration.`);
        return;
    }
    return new Promise((resolve, reject) => {
        const analyzer = (0, child_process_1.spawn)("npx", ["webpack-bundle-analyzer", statsPath], {
            stdio: "inherit",
            shell: true,
        });
        analyzer.on("error", (error) => {
            reject(new Error(`Failed to start bundle analyzer: ${error.message}`));
        });
        analyzer.on("close", () => {
            // The analyzer process has finished, so we can resolve the promise
            // to allow the build process to exit gracefully.
            resolve();
        });
    });
}
