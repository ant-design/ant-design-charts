import { DOMParser } from "domparser-rs";
import fs from "fs";
import path from "path";
export function processHtmlEntry(config, projectPath) {
    if (!config.entry)
        return;
    const newEntries = [];
    config.entry = config.entry.filter((entry) => {
        if (entry.import.endsWith(".html")) {
            const htmlPath = path.resolve(projectPath, entry.import);
            if (fs.existsSync(htmlPath)) {
                const content = fs.readFileSync(htmlPath, "utf-8");
                const parser = new DOMParser();
                const doc = parser.parseFromString(content, "text/html");
                const scripts = doc.querySelectorAll("script");
                scripts.forEach((script) => {
                    const src = script.getAttribute("src");
                    if (src && !src.startsWith("http") && !src.startsWith("//")) {
                        const scriptPath = path.join(path.dirname(entry.import), src);
                        // Remove the origin script tag from the DOM
                        if (script.parentNode) {
                            script.parentNode.removeChild(script);
                        }
                        newEntries.push({
                            import: scriptPath,
                            html: {
                                template: entry.import,
                                templateContent: doc.outerHTML,
                                filename: path.basename(entry.import),
                            },
                        });
                    }
                });
                return false;
            }
        }
        return true;
    });
    // Add new script entries
    config.entry.push(...newEntries);
}
